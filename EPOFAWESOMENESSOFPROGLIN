#! /usr/bin/octave -qf

% m = num de linhas
% n = num de colunas

function [ind x] = simplex(A,b,c,m,n,print)

	%initialize x with dummy value
	x = 0
	
	%make b positive, adjust A accordingly.
	for i = 1:m
		if b(i) < 0
			b(i) = - b(1)
			A(i,:) = -A(i,:)
		endif
	endfor
	
	%build the phase1 tableau
	cext = [-sum(A),zeros(1,m)]
	tableau = [-sum(b),cext;b,A,eye(m)]
	basis = n+1:n+m
	
	%do the phase 1 magic
	[ind tableau basis] = runsimplex(basis,tableau,m,n)
	
	%no solution? ohnoes...
	if ind != 0
		return
	endif

	%resolver problemas de vars artificiais na base
	for bi = basis
		if bi > n
			if 0 %TODO check redundant restriction
				%remove redundant restriction, ajeitando o tableau, basis, A, b, c, m, n
			else %senao, temosquepivotarout
				[basis tableau] = pivotaout(basis,tableau,bi,m,n) %TODO a funcao la em baixo
			endif
		endif
	endfor
	
	%ajeitar o tableau fase 2
	basismatrix = A(:,basis)
	cb(1:m,1) = c(basis)
	reducaocusto = basismatrix \ cb
	
	%VERIFICARSEESSAPOARRFUNFA.NAU.
	tableau = [ tableau(2:m+1,1)' * reducaocusto , reducaocusto ;tableau(2:m+1,1:n+1)]
	
	[ind tableau basis] = runsimplex(basis,tableau,m,n)
	%extrair o x
	
	x = 0
endfunction

function [ind tableau basis] = runsimplex(basis,tableau,m,n)

	while 1 %condição de saída é não achar nenhuma coluna onde melhorar.
		%choose column
		col = 2
		while col <= n+m+1 && tableau(1,col) >= 0
			++col
		endwhile
		
		%THERESNOCOLUMN
		if col > n+m+1
			if tableau(1,1) < 0
				ind = 1
			else
				ind = 0
			endif
			return
		endif

		%choose row
		row = 0
		minvalue = Inf
		for i = 2:m+1
			if tableau(i,col) > 0
				theta = tableau(i,1) / tableau(i,col)
				if minvalue > theta
					row = i
					minvalue = theta
				endif
			endif
		endfor
		
		if row == 0
			ind = -1
			return
		endif
		
		%uptade the basis vector with the new var, removing the old var
		basis(row - 1) = col - 1
		
		%put 1 hear.
		tableau(row,:) /= tableau(row,col)
		
		%put zeroes everywhear.
		for i = 1:m+1
			if i != row
				tableau(i,:) -= tableau(i,col)*tableau(row,:)
			endif
		endfor
	endwhile
	
	
endfunction

function [basis tableau]= pivotaout(basis,tableau,bi,m,n)
	
	%TODO
	%acha uma variavel básica por quem pivotar

endfunction

%TODO POR ; NA POARR TODA FOR MOAR SILENCE

m = 2
n = 3
A = [1, 2, 3; 4, 4, 5]
b = [10; 10]
c = [4; 3; 2]
simplex(A, b, c, m, n, true)
